#!/bin/sh
FILE=`readlink -f $0`
DIR=`dirname $FILE`

#UPDATE SUBMODULES IF THEY HAVEN'T BEEN
if [ "$1" != "1" ]; then
	"${DIR}/base/update-git2"
fi

#INSTALL CONFIGS
CONF="gvimrc vimrc bash_profile bashrc bash_logout zshrc zprofile"
for i in $CONF; do
	rm -f ~/.$i
	ln -sv ${DIR}/base/$i ~/.$i
done

#LINK PRELUDE
rm -f "${HOME}/.emacs" "${DIR}/prelude/personal/emacs.el"
rm -rf "${HOME}/.emacs.d"
ln -s "${DIR}/prelude" "${HOME}/.emacs.d"
ln -s "${DIR}/base/emacs_prelude" "${DIR}/prelude/personal/emacs.el"

#SETUP ZSH IF POSSIBLE
echo $SHELL | grep zsh >/dev/null 2>&1
if [ "$?" != "0" ]; then
	ZSH=`which zsh 2>/dev/null`
	VER="$(${ZSH} --version | awk '{print $2}')"
	VER=$(echo -ne "4.3.9\n$VER" | sort -bt. -k1,1 -k2,2n -k3,3n -k4,4n -k5,5n | awk 'NR==1')
	if [ "$VER" = "4.3.9" ]; then
		chsh $USER -s $ZSH
		if [ "$?" != "0" ]; then
			rm -fv ~/.bash_profile
			ln -sv ${DIR}/base/bash_profile_zsh ~/.bash_profile
		fi
	fi
fi

#SETUP SSH
if [[ ! -d ~/.ssh || ! -f ~/.ssh/id_rsa ]]; then
	echo "Creating SSH Keys"
	${DIR}/install-ssh-keys
fi
