#!/bin/sh
FILE=`readlink -f $0`
DIR=`dirname $FILE`
source ${DIR}/base/header

#UPDATE SUBMODULES IF THEY HAVEN'T BEEN
if [ "$1" != "1" ]; then
	"${DIR}/base/update-git2" 1
	exit 0
fi

#INSTALL CONFIGS
CONF="bin gvimrc vimrc bash_profile bashrc bash_logout zshrc zprofile zlogout"
for i in $CONF; do
	rm -f "$HOME/.$i"
	ln -s "$DIR/base/$i" "$HOME/.$i"
done

# USE EMACS
rm -rf "${HOME}/.emacs.d"
rm -f "${HOME}/.emacs"
ln -s "${DIR}/base/emacs.d" "${HOME}/.emacs.d"

#SETUP ZSH IF POSSIBLE
echo $SHELL | grep zsh >/dev/null 2>&1
if [ "$?" != "0" ]; then
	ZSH="$(which zsh 2>/dev/null | grep -v "not found")"
	if [ "$ZSH" != "" ]; then
		VER="$(${ZSH} --version | awk '{print $2}')"
		VER="$(printf "4.3.9\n%s" "$VER" | sort -bt. -k1,1n -k2,2n -k3,3n -k4,4n -k5,5n | awk 'NR==1')"
		if [ "$VER" = "4.3.9" ]; then
			chsh -s "$ZSH" "$USER"
			if [ "$?" != "0" ]; then
				rm -fv ~/.bash_profile ~/.bashrc
				ln -s ${DIR}/base/bash_profile_zsh ~/.bash_profile
                ln -s ${DIR}/base/bashrc_zsh ~/.bashrc
			fi
		fi
	fi
fi

# SETUP SSH
if [ ! -f ~/.ssh/id_rsa.pub ]; then
    if [ "$WS" -eq "1" ]; then
        echo "Copying Smartcard Key"
        cp ${DIR}/ssh/smartcard_rsa ~/.ssh/id_rsa.pub
    else
        echo "Creating SSH Keys"
        ${DIR}/install-ssh-keys
    fi
fi
ssh-keygen -H >/dev/null 2>&1
rm -f ~/.ssh/known_hosts.old
rm -f ~/.ssh/config
ln -s "${DIR}/base/ssh_config" ~/.ssh/config
